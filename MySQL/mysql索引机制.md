## MySQL索引机制

### 索引基础知识

页是InnoDB管理存储空间的基本单位，一个页的大小默认是16KB。

SHOW GLOBAL STATUS like 'Innodb_page_size';

页的结构如下所示

![1576825410409](C:\Users\WPC\AppData\Roaming\Typora\typora-user-images\1576825410409.png)

1.每次对数据进行操作时，首先要把磁盘上的数据加载到内存，页就是数据库操作的基本单位

2.行记录存储在页中，每个页都有对应的**页号**和**页目录**，各个页之间形成**双向链表**，记录之间又形成**单向链表**

在通过**主键**查找某条记录的时候可以在页目录中使用**二分法快速定位**到对应的槽，然后再遍历该槽对应分组中的记录即可快速找到指定的记录而以**其他列**(非主键)作为搜索条件就只能从最小记录开始**依次遍历单链表中的每条记录**。

索引的底层结构是B+树，而B+树的节点就是页，索引可以加快查询速度，但是也降低了增删改的速度

### 聚簇索引和非聚簇索引

- 聚簇索引就是以**主键**创建的索引
- 非聚簇索引就是以**非主键**创建的索引

聚簇索引的特点：
1. 按主键值的大小进行记录和页的排序：
数据页(叶子节点)里的记录是按照主键值**从小到大排序**的一个单向链表。
数据页(叶子节点)之间也是是按照主键值**从小到大排序**的一个双向链表。
B+树中同一个层的页目录也是按照主键值**从小到大排序**的一个双向链表。
2. B+树的叶子节点存储的是完整的用户记录，就是指这个记录中存储了

区别：

- 聚簇索引在叶子节点存储的是**表中的数据**
- 非聚簇索引在叶子节点存储的是**索引列和主键**
- 使用非聚簇索引查询出数据时，**拿到叶子上的主键再去查到想要查找的数据**。(拿到主键再查找这个过程叫做**回表**)

### 索引的代价

**空间代价**

一个索引都为对应一棵B+树，树中每一个节点都是一个数据页，一个页默认会占用16KB的存储空间，所以一个
索引也是会占用磁盘空间的。

**时间代价**

索引是对数据的排序，那么当对表中的数据进行增、删、改操作时，都需要去维护修改内容涉及到的B+树索引。
所以在进行增、删、改操作时可能需要额外的时间进行一些记录移动，页面分裂、页面回收等操作来维护好排
序。



### 如何建立索引

**考虑索引选择性**

索引的选择性（Selectivity），是指不重复的索引值（也叫基数，Cardinality）与表记录数的比值：

选择性 = 不重复的索引数 / 记录数

选择性的取值范围为(0, 1]，选择性越高的索引价值越大。如果选择性等于1，就代表这个列的不重复值和表记录
数是一样的，那么对这个列建立索引是非常合适的，如果选择性非常小，那么就代表这个列的重复值是很多的，
不适合建立索引

**考虑前缀索引**

用列的前缀代替整个列作为索引key，当前缀长度合适时，可以做到既使得前缀索引的选择性接近全列索引，同
时因为索引key变短而减少了索引文件的大小和维护开销。

### 总结：

索引列的类型尽量小
利用索引字符串值的前缀
主键自增
定位并删除表中的重复和冗余索引
尽量使用覆盖索引进行查询，避免回表带来的性能损耗。